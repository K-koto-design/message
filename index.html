<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>–ö–û–õ–ò–ß</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>

    <style>
        :root {
            --vk-blue: #0077ff;
            --bg: #0a0a0a;
            --card: #1c1c1e;
            --text: #ffffff;
            --text-sec: #8e8e93;
            --my-msg: #0077ff;
            --other-msg: #2c2c2e;
        }

        * { box-sizing: border-box; font-family: -apple-system, system-ui, sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        header {
            padding: 12px 16px;
            background: rgba(28, 28, 30, 0.8);
            backdrop-filter: blur(20px);
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 0.5px solid #333;
            padding-top: calc(12px + env(safe-area-inset-top));
            z-index: 100;
        }
        .profile-info { display: flex; align-items: center; gap: 10px; overflow: hidden; }
        .avatar-main { min-width: 36px; height: 36px; border-radius: 12px; background: var(--vk-blue); display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .header-text { overflow: hidden; }
        .header-text b { display: block; }
        .header-text small { color: var(--vk-blue); display: block; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px; }

        #chat-flow { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 8px; }
        
        .msg-wrap { display: flex; flex-direction: column; position: relative; max-width: 80%; }
        .msg-wrap.my { align-self: flex-end; }
        .msg-wrap.other { align-self: flex-start; }

        .msg { padding: 10px 14px; border-radius: 18px; font-size: 15px; line-height: 1.4; cursor: pointer; position: relative; }
        .my .msg { background: var(--my-msg); border-bottom-right-radius: 4px; }
        .other .msg { background: var(--other-msg); border-bottom-left-radius: 4px; }
        
        .sender { font-size: 11px; font-weight: 600; margin-bottom: 2px; opacity: 0.7; }
        .msg img { max-width: 100%; border-radius: 12px; margin-top: 5px; }

        .react-menu {
            display: none; position: absolute; top: -45px; background: var(--card);
            border-radius: 20px; padding: 6px 12px; gap: 10px; border: 1px solid #444;
            z-index: 1000; box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        .react-item { cursor: pointer; font-size: 20px; }

        .react-row { display: flex; gap: 4px; margin-top: -6px; }
        .my .react-row { justify-content: flex-end; }
        .bubble { background: #2c2c2e; border: 1px solid var(--bg); border-radius: 10px; padding: 2px 7px; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 3px; }
        .bubble.active { border-color: var(--vk-blue); background: #3a3a3c; }

        .input-area { background: var(--card); padding: 10px 15px calc(15px + env(safe-area-inset-bottom)); display: flex; align-items: center; gap: 12px; }
        .input-wrap { flex: 1; background: #2c2c2e; border-radius: 20px; padding: 8px 15px; }
        input[type="text"], input[type="password"] { width: 100%; background: transparent; border: none; color: white; outline: none; font-size: 16px; }

        #auth-screen { position: fixed; inset: 0; background: var(--bg); z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .login-box { width: 100%; max-width: 320px; text-align: center; padding: 20px; }
        .login-box h1 { margin-bottom: 20px; }
        .login-box input { width: 100%; padding: 16px; border-radius: 16px; border: none; background: var(--card); color: white; margin-bottom: 12px; text-align: center; }
        .login-box button { width: 100%; padding: 16px; border-radius: 16px; border: none; background: var(--vk-blue); color: white; font-weight: bold; width: 100%; cursor: pointer; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="login-box">
            <h1>–ö–û–õ–ò–ß</h1>
            <input type="text" id="user-name" placeholder="–õ–æ–≥–∏–Ω">
            <input type="password" id="user-pass" placeholder="–ü–∞—Ä–æ–ª—å">
            <button onclick="handleLogin()">–í–æ–π—Ç–∏</button>
            <p id="error-msg" style="color: #ff3b30; font-size: 13px; margin-top: 10px; display: none;"></p>
        </div>
    </div>

    <header>
        <div class="profile-info">
            <div class="avatar-main" id="my-avatar">?</div>
            <div class="header-text">
                <b>–ß–ê–¢ –ö–û–¢–û–ë–ê–ù–ö</b>
                <small id="online-list">–í —Å–µ—Ç–∏: –∑–∞–≥—Ä—É–∑–∫–∞...</small>
            </div>
        </div>
        <div onclick="logout()" style="color:var(--text-sec); cursor:pointer; font-size: 14px;">–í—ã—Ö–æ–¥</div>
    </header>

    <div id="chat-flow"></div>

    <div class="input-area">
        <label style="color: var(--vk-blue); cursor: pointer;">
            <svg width="28" height="28" fill="currentColor" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
            <input type="file" id="file-input" hidden accept="image/*" onchange="uploadFile(this)">
        </label>
        <div class="input-wrap"><input type="text" id="msg-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ..."></div>
        <div onclick="sendMsg()" style="color: var(--vk-blue); cursor: pointer;">
            <svg width="28" height="28" fill="currentColor" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyA3J7KnUgxUHZigwRKmndm7xyxJeeLCrxg",
            databaseURL: "https://webapp-b7149-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "webapp-b7149",
            storageBucket: "webapp-b7149.appspot.com"
        };
        firebase.initializeApp(firebaseConfig);
        const rdb = firebase.database();
        const chatDb = rdb.ref('max_global_chat');
        const usersDb = rdb.ref('registered_users');
        const onlineDb = rdb.ref('online_users');
        const storage = firebase.storage().ref('chat_media');

        let user = JSON.parse(localStorage.getItem('max_session'));

        if(user) {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('my-avatar').innerText = user.name[0].toUpperCase();
            initPresence();
            initChat();
        }

        function initPresence() {
            const myStatusRef = onlineDb.child(user.id);
            rdb.ref('.info/connected').on('value', snap => {
                if (snap.val() === false) return;
                myStatusRef.onDisconnect().remove();
                myStatusRef.set(user.name);
            });
            onlineDb.on('value', snap => {
                const names = [];
                snap.forEach(child => { names.push(child.val()); });
                document.getElementById('online-list').innerText = "–í —Å–µ—Ç–∏: " + names.join(", ");
            });
        }

        async function handleLogin() {
            const name = document.getElementById('user-name').value.trim();
            const pass = document.getElementById('user-pass').value.trim();
            if(!name || !pass) return;

            usersDb.child(name).once('value', snap => {
                const data = snap.val();
                if(data) {
                    if(data.password === pass) {
                        localStorage.setItem('max_session', JSON.stringify(data));
                        location.reload();
                    } else { alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!"); }
                } else {
                    const newUser = { id: 'u' + Date.now(), name: name, password: pass };
                    usersDb.child(name).set(newUser);
                    localStorage.setItem('max_session', JSON.stringify(newUser));
                    location.reload();
                }
            });
        }

        function logout() {
            if(user) onlineDb.child(user.id).remove();
            localStorage.removeItem('max_session');
            location.reload();
        }

        function toggleReact(key) {
            const el = document.getElementById('menu-' + key);
            const open = el.style.display === 'flex';
            document.querySelectorAll('.react-menu').forEach(m => m.style.display = 'none');
            if(!open) el.style.display = 'flex';
        }

        function addReaction(key, emoji) {
            const ref = rdb.ref(`max_global_chat/${key}/reactions`);
            ref.once('value', snap => {
                const reacts = snap.val() || {};
                // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é —Ä–µ–∞–∫—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –µ—Å–ª–∏ –æ–Ω–∞ –±—ã–ª–∞
                for(let e in reacts) {
                    if(reacts[e][user.id]) delete reacts[e][user.id];
                    if(Object.keys(reacts[e] || {}).length === 0) delete reacts[e];
                }
                // –ï—Å–ª–∏ –Ω–∞–∂–∞–ª–∏ –Ω–∞ —Ç—É –∂–µ, —á—Ç–æ –∏ –±—ã–ª–∞ ‚Äî –ø—Ä–æ—Å—Ç–æ —Å–Ω–∏–º–∞–µ–º. –ï—Å–ª–∏ –Ω–∞ –Ω–æ–≤—É—é ‚Äî —Å—Ç–∞–≤–∏–º.
                if(!snap.child(emoji).child(user.id).exists()) {
                    if(!reacts[emoji]) reacts[emoji] = {};
                    reacts[emoji][user.id] = true;
                }
                ref.set(reacts);
            });
            document.getElementById('menu-' + key).style.display = 'none';
        }

        function initChat() {
            chatDb.limitToLast(50).on('value', snap => {
                const flow = document.getElementById('chat-flow');
                flow.innerHTML = "";
                snap.forEach(child => {
                    const m = child.val();
                    const k = child.key;
                    const isMy = m.uid === user.id;
                    const wrap = document.createElement('div');
                    wrap.className = `msg-wrap ${isMy ? 'my' : 'other'}`;

                    let html = `
                        <div class="react-menu" id="menu-${k}">
                            <span class="react-item" onclick="addReaction('${k}','‚ù§Ô∏è')">‚ù§Ô∏è</span>
                            <span class="react-item" onclick="addReaction('${k}','üëç')">üëç</span>
                        </div>
                        <div class="msg" onclick="toggleReact('${k}')">
                            <span class="sender">${m.user}</span>
                            ${m.type === 'text' ? `<div>${m.text}</div>` : `<img src="${m.url}">`}
                        </div>
                    `;

                    if(m.reactions) {
                        html += `<div class="react-row">`;
                        for(let emoji in m.reactions) {
                            const count = Object.keys(m.reactions[emoji]).length;
                            const active = m.reactions[emoji][user.id] ? 'active' : '';
                            if(count > 0) html += `<div class="bubble ${active}" onclick="addReaction('${k}','${emoji}')">${emoji} ${count}</div>`;
                        }
                        html += `</div>`;
                    }
                    wrap.innerHTML = html; flow.appendChild(wrap);
                });
                flow.scrollTop = flow.scrollHeight;
            });
        }

        function sendMsg() {
            const inp = document.getElementById('msg-input');
            if(!inp.value.trim()) return;
            chatDb.push({ uid: user.id, user: user.name, text: inp.value, type: 'text', time: Date.now() });
            inp.value = "";
        }

        async function uploadFile(el) {
            const file = el.files[0]; if(!file) return;
            const ref = storage.child(Date.now() + '_' + file.name);
            await ref.put(file);
            const url = await ref.getDownloadURL();
            chatDb.push({ uid: user.id, user: user.name, url: url, type: 'img', time: Date.now() });
        }

        document.getElementById('msg-input').onkeypress = e => { if(e.key === 'Enter') sendMsg(); };
    </script>
</body>
</html>
