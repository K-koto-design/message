<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–ö–û–õ–ò–ß</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>

    <style>
        :root {
            --vk-blue: #0077ff;
            --bg: #000000;
            --card: #1c1c1e;
            --text: #ffffff;
            --text-sec: #8e8e93;
            --my-msg: #0077ff;
            --other-msg: #262629;
            --header-h: calc(env(safe-area-inset-top) + 65px);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, sans-serif; }
        html, body { margin: 0; padding: 0; background: var(--bg); color: var(--text); height: 100%; width: 100%; overflow: hidden; position: fixed; }

        header {
            position: fixed; top: 0; left: 0; right: 0; height: var(--header-h);
            padding: calc(env(safe-area-inset-top) + 20px) 16px 10px;
            background: rgba(10, 10, 10, 0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            display: flex; align-items: center; justify-content: space-between; border-bottom: 0.5px solid #2c2c2e; z-index: 1000;
        }
        
        .avatar-main { width: 38px; height: 38px; border-radius: 10px; background: var(--vk-blue); display: flex; align-items: center; justify-content: center; font-weight: 700; cursor: pointer; }
        .header-center { flex: 1; margin-left: 12px; }
        .header-center b { display: block; font-size: 16px; }
        .online-text { color: var(--vk-blue); font-size: 11px; }

        #chat-flow { 
            position: absolute; top: var(--header-h); bottom: 70px; left: 0; right: 0;
            overflow-y: auto; padding: 15px 12px; display: flex; flex-direction: column; gap: 14px;
            -webkit-overflow-scrolling: touch;
        }
        
        .msg-wrap { display: flex; flex-direction: column; max-width: 85%; position: relative; }
        .msg-wrap.my { align-self: flex-end; }
        .msg-wrap.other { align-self: flex-start; }
        .sender { font-size: 11px; font-weight: 600; margin: 0 0 2px 4px; color: var(--text-sec); }
        .msg { padding: 10px 14px; border-radius: 18px; font-size: 16px; line-height: 1.4; word-wrap: break-word; }
        .my .msg { background: var(--my-msg); border-bottom-right-radius: 4px; }
        .other .msg { background: var(--other-msg); border-bottom-left-radius: 4px; }
        .msg img { max-width: 100%; border-radius: 12px; display: block; margin-top: 5px; }

        .reaction-row { display: flex; gap: 4px; margin-top: -8px; z-index: 10; }
        .my .reaction-row { justify-content: flex-end; }
        .bubble { background: #262629; border: 1px solid #000; border-radius: 12px; padding: 2px 8px; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 4px; }
        .bubble.active { border-color: var(--vk-blue); background: #3a3a3c; }

        .react-menu { display: none; position: absolute; top: -50px; background: #2c2c2e; border-radius: 20px; padding: 6px 12px; gap: 12px; border: 0.5px solid #444; z-index: 1100; align-items: center; }
        .menu-btn { font-size: 13px; color: white; cursor: pointer; font-weight: 500; }

        #contacts-modal { position: fixed; inset: 0; background: #000; z-index: 2000; display: none; flex-direction: column; padding: 60px 20px; }
        .contact-item { padding: 15px; border-bottom: 0.5px solid #333; display: flex; align-items: center; gap: 10px; font-weight: 600; cursor: pointer; }

        .bottom-controls { position: fixed; bottom: 0; left: 0; right: 0; background: #141416; z-index: 1000; padding-bottom: env(safe-area-inset-bottom); }
        .input-area { padding: 10px 12px; display: flex; align-items: center; gap: 8px; }
        .input-wrap { flex: 1; background: #262629; border-radius: 20px; padding: 8px 15px; }
        #msg-input { width: 100%; background: transparent; border: none; color: white; font-size: 16px; outline: none; }
        .icon-btn { color: var(--vk-blue); cursor: pointer; display: flex; align-items: center; padding: 4px; }

        #auth-screen { position: fixed; inset: 0; background: #000; z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .login-box { width: 80%; text-align: center; }
        .login-box input { width: 100%; padding: 16px; border-radius: 16px; border: none; background: #1c1c1e; color: white; margin-bottom: 12px; text-align: center; }
        .login-box button { width: 100%; padding: 16px; border-radius: 16px; border: none; background: var(--vk-blue); color: white; font-weight: 700; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="login-box">
            <h1>–ö–û–õ–ò–ß</h1>
            <input type="text" id="user-name" placeholder="–ò–º—è">
            <input type="password" id="user-pass" placeholder="–ü–∞—Ä–æ–ª—å">
            <button onclick="handleLogin()">–í–æ–π—Ç–∏</button>
        </div>
    </div>

    <div id="contacts-modal">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
            <h2 style="margin:0">–†–∞–∑–¥–µ–ª—ã</h2>
            <button onclick="toggleContacts(false)" style="background:none; border:none; color:white; font-size:24px;">‚úï</button>
        </div>
        <div class="contact-item" style="color:var(--vk-blue)" onclick="switchChat('messages', '–ß–ê–¢ –ö–û–¢–û–ë–ê–ù–ö')">üì¢ –ß–ê–¢ –ö–û–¢–û–ë–ê–ù–ö</div>
        <div style="padding: 10px; color: var(--text-sec); font-size: 12px;">–õ–ò–ß–ù–´–ï –°–û–û–ë–©–ï–ù–ò–Ø</div>
        <div id="contacts-list"></div>
    </div>

    <header>
        <div style="display:flex; align-items:center;" onclick="toggleContacts(true)">
            <div class="avatar-main" id="chat-avatar">üì¢</div>
            <div class="header-center">
                <b id="chat-title">–ß–ê–¢ –ö–û–¢–û–ë–ê–ù–ö</b>
                <span class="online-text" id="online-list">...</span>
            </div>
        </div>
        <div onclick="logout()" style="color:var(--text-sec); font-size: 13px; cursor:pointer;">–í—ã—Ö–æ–¥</div>
    </header>

    <div id="chat-flow"></div>

    <div class="bottom-controls">
        <div id="reply-preview" style="display:none; background:#1c1c1e; padding:8px 16px; border-top:0.5px solid #333; justify-content:space-between; align-items:center;">
            <div id="reply-info" style="font-size:12px; border-left:2px solid var(--vk-blue); padding-left:8px; overflow:hidden;"></div>
            <div onclick="cancelReply()" style="padding:5px; cursor:pointer;">‚úï</div>
        </div>
        <div class="input-area">
            <div class="icon-btn" onclick="sendImgByUrl()">
                <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2.2" viewBox="0 0 24 24"><path d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </div>
            <div class="input-wrap">
                <input type="text" id="msg-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ" autocomplete="off">
            </div>
            <div onclick="sendMsg()" class="icon-btn">
                <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
            </div>
        </div>
    </div>

    <script>
        const TG_PUBLIC_BOT = "8548215166:AAHhHo_ODrDZl-6Lg5Zi-BpBIpeMzXdOEFE";
        const TG_PUBLIC_CHAT = "-1003486195563";
        const TG_PRIVATE_BOT = "7849346493:AAED-9akdGQ_hy9VBBKmQ7x33A3QKNhJSBc"; 
        const TG_PRIVATE_CHAT = "-1003543377987";

        const firebaseConfig = {
            apiKey: "AIzaSyARNjukxBwGfbODNpYRDowRg5ftB9qtZSU",
            authDomain: "message-65b09.firebaseapp.com",
            projectId: "message-65b09",
            storageBucket: "message-65b09.firebasestorage.app",
            messagingSenderId: "251547828052",
            appId: "1:251547828052:web:cee4f2b765d50e8572d2c1",
            databaseURL: "https://message-65b09-default-rtdb.firebaseio.com"
        };

        firebase.initializeApp(firebaseConfig);
        const rdb = firebase.database();
        const usersDb = rdb.ref('users');
        const onlineDb = rdb.ref('online');

        let user = JSON.parse(localStorage.getItem('max_session'));
        let currentChatId = 'messages';
        let replyData = null;

        if (user) {
            document.getElementById('auth-screen').style.display = 'none';
            initPresence();
            loadContacts();
            switchChat('messages', '–ß–ê–¢ –ö–û–¢–û–ë–ê–ù–ö');
        }

        async function handleLogin() {
            const n = document.getElementById('user-name').value.trim();
            const p = document.getElementById('user-pass').value.trim();
            if(!n || !p) return;
            const snap = await usersDb.child(n.toLowerCase()).once('value');
            const data = snap.val();
            if(data && data.password === p) { localStorage.setItem('max_session', JSON.stringify(data)); location.reload(); }
            else if(!data) {
                const newUser = { id: 'u' + Date.now(), name: n, password: p };
                await usersDb.child(n.toLowerCase()).set(newUser);
                localStorage.setItem('max_session', JSON.stringify(newUser));
                location.reload();
            } else { alert("–û—à–∏–±–∫–∞ –ø–∞—Ä–æ–ª—è!"); }
        }

        function initPresence() {
            onlineDb.child(user.id).set(user.name);
            onlineDb.child(user.id).onDisconnect().remove();
            onlineDb.on('value', s => {
                let n = []; s.forEach(c => n.push(c.val()));
                document.getElementById('online-list').innerText = "–í —Å–µ—Ç–∏: " + n.join(", ");
            });
        }

        function loadContacts() {
            usersDb.on('value', s => {
                const list = document.getElementById('contacts-list');
                list.innerHTML = "";
                s.forEach(c => {
                    const u = c.val(); if(u.id === user.id) return;
                    const d = document.createElement('div');
                    d.className = 'contact-item';
                    d.innerHTML = `üë§ ${u.name}`;
                    d.onclick = () => { 
                        // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π ID –¥–ª—è –æ–±–æ–∏—Ö —Å–æ–±–µ—Å–µ–¥–Ω–∏–∫–æ–≤
                        const chatId = [user.id, u.id].sort().join('_');
                        switchChat(chatId, u.name); 
                        toggleContacts(false); 
                    };
                    list.appendChild(d);
                });
            });
        }

        function switchChat(id, title) {
            // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ —Å–ª—É—à–∞—Ç–µ–ª–∏ –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ—Ö–æ–¥–æ–º
            if (currentChatId === 'messages') {
                rdb.ref('messages').off();
            } else {
                rdb.ref('private_chats/' + currentChatId).off();
            }

            currentChatId = id;
            document.getElementById('chat-title').innerText = title;
            document.getElementById('chat-avatar').innerText = (id === 'messages') ? 'üì¢' : title[0];
            
            const dbPath = (id === 'messages') ? 'messages' : 'private_chats/' + id;
            initChatListener(dbPath);
        }

        function initChatListener(dbPath) {
            const flow = document.getElementById('chat-flow');
            rdb.ref(dbPath).limitToLast(50).on('value', snap => {
                flow.innerHTML = "";
                snap.forEach(child => {
                    const m = child.val();
                    const k = child.key;
                    const isMy = m.uid === user.id;
                    const wrap = document.createElement('div');
                    wrap.className = `msg-wrap ${isMy ? 'my' : 'other'}`;
                    
                    let reactionsHtml = '';
                    if(m.reactions) {
                        reactionsHtml = `<div class="reaction-row">`;
                        for(let emoji in m.reactions) {
                            const count = Object.keys(m.reactions[emoji]).length;
                            const active = m.reactions[emoji][user.id] ? 'active' : '';
                            reactionsHtml += `<div class="bubble ${active}" onclick="addReact('${k}','${emoji}')">${emoji} ${count}</div>`;
                        }
                        reactionsHtml += `</div>`;
                    }

                    wrap.innerHTML = `
                        ${!isMy ? `<span class="sender">${m.user}</span>` : ''}
                        <div class="react-menu" id="menu-${k}">
                            <span class="menu-btn" onclick="addReact('${k}','‚ù§Ô∏è')">‚ù§Ô∏è</span>
                            <span class="menu-btn" onclick="setReply('${k}','${m.user}','${m.text||'–§–æ—Ç–æ'}')">–û—Ç–≤–µ—Ç</span>
                            ${isMy ? `<span class="menu-btn" style="color:#ff453a" onclick="deleteMsg('${k}')">–£–¥–∞–ª–∏—Ç—å</span>` : ''}
                        </div>
                        <div class="msg" onclick="showMenu('${k}')">
                            ${m.replyTo ? `<div style="border-left:2px solid #fff;padding-left:5px;font-size:12px;opacity:0.6;margin-bottom:5px"><b>${m.replyTo.name}</b><br>${m.replyTo.text}</div>` : ''}
                            ${m.type === 'text' ? `<div>${m.text}</div>` : `<img src="${m.url}">`}
                        </div>
                        ${reactionsHtml}
                    `;
                    flow.appendChild(wrap);
                });
                flow.scrollTop = flow.scrollHeight;
            });
        }

        function addReact(k, emoji) {
            const dbPath = currentChatId === 'messages' ? `messages/${k}/reactions/${emoji}` : `private_chats/${currentChatId}/${k}/reactions/${emoji}`;
            rdb.ref(dbPath).transaction(current => {
                if(!current) current = {};
                if(current[user.id]) delete current[user.id];
                else current[user.id] = true;
                return current;
            });
            document.querySelectorAll('.react-menu').forEach(m => m.style.display = 'none');
        }

        async function notifyTg(text) {
            const isPrivate = currentChatId !== 'messages';
            const token = isPrivate ? TG_PRIVATE_BOT : TG_PUBLIC_BOT;
            const chat = isPrivate ? TG_PRIVATE_CHAT : TG_PUBLIC_CHAT;
            const pref = isPrivate ? "üì© [–õ–ò–ß–ö–ê]" : "üì¢ [–û–ë–©–ò–ô]";
            
            fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ chat_id: chat, text: `${pref} *${user.name}*:\n${text}`, parse_mode: "Markdown" })
            });
        }

        function sendMsg() {
            const i = document.getElementById('msg-input'); 
            const val = i.value.trim();
            if(!val) return;
            
            const dbPath = currentChatId === 'messages' ? 'messages' : 'private_chats/' + currentChatId;
            const data = { uid: user.id, user: user.name, text: val, type: 'text', ts: Date.now() };
            if(replyData) data.replyTo = replyData;
            
            rdb.ref(dbPath).push(data);
            notifyTg(val);
            i.value = ""; cancelReply();
        }

        function sendImgByUrl() {
            const url = prompt("–°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ—Ç–æ:");
            if(!url || !url.startsWith('http')) return;
            const dbPath = currentChatId === 'messages' ? 'messages' : 'private_chats/' + currentChatId;
            rdb.ref(dbPath).push({ uid: user.id, user: user.name, url: url, type: 'img', ts: Date.now() });
            notifyTg("üì∑ –§–æ—Ç–æ –ø–æ —Å—Å—ã–ª–∫–µ");
        }

        function deleteMsg(k) {
            if(!confirm("–£–¥–∞–ª–∏—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è –≤—Å–µ—Ö?")) return;
            const dbPath = currentChatId === 'messages' ? 'messages' : 'private_chats/' + currentChatId;
            rdb.ref(`${dbPath}/${k}`).remove();
        }

        function showMenu(k) { 
            const m = document.getElementById('menu-' + k);
            const isOpen = m.style.display === 'flex';
            document.querySelectorAll('.react-menu').forEach(x => x.style.display = 'none');
            if(!isOpen) m.style.display = 'flex';
        }

        function toggleContacts(s) { document.getElementById('contacts-modal').style.display = s ? 'flex' : 'none'; }
        
        function setReply(k,n,t) { 
            replyData = { key:k, name:n, text:t }; 
            document.getElementById('reply-info').innerHTML = `<b>${n}</b><br>${t}`;
            document.getElementById('reply-preview').style.display = 'flex';
            document.querySelectorAll('.react-menu').forEach(x => x.style.display = 'none');
        }

        function cancelReply() { replyData = null; document.getElementById('reply-preview').style.display = 'none'; }
        function logout() { onlineDb.child(user.id).remove(); localStorage.clear(); location.reload(); }
        document.getElementById('msg-input').onkeypress = e => { if(e.key === 'Enter') sendMsg(); };
    </script>
</body>
</html>
