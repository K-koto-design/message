<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Cloud Messenger</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>

    <style>
        :root {
            --bg: #f2f3f7; --accent: #007aff; --card: #ffffff; --text: #1c1c1e;
            --secondary: #8e8e93; --user-msg: #007aff; --other-msg: #e5e5ea;
        }
        * { box-sizing: border-box; font-family: -apple-system, sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; }
        
        /* Экран входа */
        #login-screen { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100%; padding: 20px; }
        .login-card { background: var(--card); padding: 30px; border-radius: 24px; width: 100%; max-width: 350px; text-align: center; box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        
        /* Экран чата */
        #chat-screen { display: none; flex-direction: column; height: 100vh; }
        header { background: var(--card); padding: 15px 20px; border-bottom: 1px solid #ddd; display: flex; justify-content: space-between; align-items: center; }
        
        #messages { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 10px; }
        
        /* Стили сообщений */
        .msg { max-width: 80%; padding: 10px 14px; border-radius: 18px; position: relative; font-size: 15px; line-height: 1.4; }
        .msg .sender { font-size: 11px; font-weight: 700; margin-bottom: 4px; display: block; opacity: 0.7; }
        .msg.my { align-self: flex-end; background: var(--user-msg); color: white; border-bottom-right-radius: 4px; }
        .msg.others { align-self: flex-start; background: var(--other-msg); color: black; border-bottom-left-radius: 4px; }
        
        /* Медиа контент */
        .msg img, .msg video { max-width: 100%; border-radius: 12px; margin-top: 5px; display: block; }
        
        /* Поле ввода */
        .input-area { background: var(--card); padding: 10px 15px; display: flex; gap: 10px; align-items: center; border-top: 1px solid #ddd; padding-bottom: env(safe-area-inset-bottom); }
        input[type="text"] { flex: 1; padding: 12px 18px; border-radius: 25px; border: 1px solid #ddd; outline: none; font-size: 16px; }
        .btn-send { background: var(--accent); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 18px; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-attach { background: #e8f0ff; color: var(--accent); border: none; width: 40px; height: 40px; border-radius: 50%; font-size: 20px; cursor: pointer; }
        
        #loading { font-size: 12px; color: var(--accent); display: none; text-align: center; padding: 5px; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-card">
            <h2>Вход в мессенджер</h2>
            <input type="text" id="username-input" placeholder="Ваше имя" style="width: 100%; margin-bottom: 15px; padding: 12px; border-radius: 12px; border: 1px solid #ddd;">
            <button onclick="login()" style="width: 100%; padding: 12px; border-radius: 12px; border: none; background: var(--accent); color: white; font-weight: 600;">Войти</button>
        </div>
    </div>

    <div id="chat-screen">
        <header>
            <b id="display-name">Чат</b>
            <button onclick="logout()" style="background:none; border:none; color: var(--red); font-size: 13px;">Выйти</button>
        </header>

        <div id="messages"></div>
        <div id="loading">Загрузка файла...</div>

        <div class="input-area">
            <button class="btn-attach" onclick="document.getElementById('file-input').click()">+</button>
            <input type="file" id="file-input" hidden accept="image/*,video/*" onchange="uploadFile(this)">
            <input type="text" id="msg-input" placeholder="Сообщение...">
            <button class="btn-send" onclick="sendText()">➤</button>
        </div>
    </div>

    <script>
        // КОНФИГУРАЦИЯ FIREBASE (использую те же ключи, что и в банке)
        const firebaseConfig = {
            apiKey: "AIzaSyA3J7KnUgxUHZigwRKmndm7xyxJeeLCrxg",
            authDomain: "webapp-b7149.firebaseapp.com",
            databaseURL: "https://webapp-b7149-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "webapp-b7149",
            storageBucket: "webapp-b7149.appspot.com",
            messagingSenderId: "1034835242406",
            appId: "1:1034835242406:web:98499dc1edbb83e4b8f367"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database().ref('global_chat');
        const storage = firebase.storage().ref('chat_media');

        let currentUser = localStorage.getItem('chat_user');

        // Логика входа
        function login() {
            const name = document.getElementById('username-input').value.trim();
            if (name) {
                localStorage.setItem('chat_user', name);
                location.reload();
            }
        }

        function logout() {
            localStorage.removeItem('chat_user');
            location.reload();
        }

        if (currentUser) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('chat-screen').style.display = 'flex';
            document.getElementById('display-name').innerText = currentUser;
            loadMessages();
        }

        // Отправка текста
        function sendText() {
            const inp = document.getElementById('msg-input');
            const text = inp.value.trim();
            if (!text) return;

            db.push({
                user: currentUser,
                text: text,
                type: 'text',
                time: Date.now()
            });
            inp.value = "";
        }

        // Загрузка фото/видео
        function uploadFile(input) {
            const file = input.files[0];
            if (!file) return;

            const loader = document.getElementById('loading');
            loader.style.display = 'block';

            const fileName = Date.now() + '_' + file.name;
            const fileRef = storage.child(fileName);

            fileRef.put(file).then(snapshot => {
                return snapshot.ref.getDownloadURL();
            }).then(url => {
                db.push({
                    user: currentUser,
                    url: url,
                    type: file.type.includes('image') ? 'image' : 'video',
                    time: Date.now()
                });
                loader.style.display = 'none';
                input.value = "";
            }).catch(err => {
                alert("Ошибка загрузки");
                loader.style.display = 'none';
            });
        }

        // Отображение сообщений
        function loadMessages() {
            db.limitToLast(50).on('value', (snapshot) => {
                const container = document.getElementById('messages');
                container.innerHTML = "";
                const data = snapshot.val();
                if (!data) return;

                Object.values(data).forEach(m => {
                    const isMy = m.user === currentUser;
                    const msgDiv = document.createElement('div');
                    msgDiv.className = `msg ${isMy ? 'my' : 'others'}`;
                    
                    let content = `<span class="sender">${m.user}</span>`;
                    
                    if (m.type === 'text') {
                        content += `<span>${m.text}</span>`;
                    } else if (m.type === 'image') {
                        content += `<img src="${m.url}" onclick="window.open('${m.url}')">`;
                    } else if (m.type === 'video') {
                        content += `<video src="${m.url}" controls></video>`;
                    }

                    msgDiv.innerHTML = content;
                    container.appendChild(msgDiv);
                });
                container.scrollTop = container.scrollHeight;
            });
        }

        // Отправка по Enter
        document.getElementById('msg-input').onkeypress = function(e) {
            if (e.keyCode === 13) sendText();
        };
    </script>
</body>
</html>
