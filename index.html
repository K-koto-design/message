<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>–ö–û–õ–ò–ß</title>
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>

    <style>
        :root {
            --vk-blue: #0077ff;
            --bg: #0a0a0a;
            --card: #1c1c1e;
            --text: #ffffff;
            --text-sec: #8e8e93;
            --my-msg: #0077ff;
            --other-msg: #2c2c2e;
        }

        * { box-sizing: border-box; font-family: -apple-system, system-ui, sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        header {
            padding: 12px 16px;
            background: rgba(28, 28, 30, 0.8);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 0.5px solid #333;
            padding-top: calc(12px + env(safe-area-inset-top));
            z-index: 100;
        }
        .profile-info { display: flex; align-items: center; gap: 10px; }
        .avatar-main { width: 36px; height: 36px; border-radius: 12px; background: var(--vk-blue); display: flex; align-items: center; justify-content: center; font-weight: bold; }

        #chat-flow { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 12px; background: var(--bg); }
        .msg { max-width: 80%; padding: 10px 14px; border-radius: 18px; font-size: 15px; line-height: 1.4; position: relative; animation: slideUp 0.2s ease; }
        @keyframes slideUp { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }
        
        .msg.my { align-self: flex-end; background: var(--my-msg); border-bottom-right-radius: 4px; }
        .msg.other { align-self: flex-start; background: var(--other-msg); border-bottom-left-radius: 4px; }
        .sender { font-size: 11px; font-weight: 600; margin-bottom: 2px; opacity: 0.7; display: block; }
        .msg img, .msg video { max-width: 100%; border-radius: 12px; margin-top: 5px; display: block; }

        /* –†–ï–ê–ö–¶–ò–ò */
        .reactions-wrap {
            display: flex; gap: 4px; margin-top: 6px;
        }
        .react-btn {
            background: rgba(255,255,255,0.1);
            border-radius: 10px; padding: 2px 6px; font-size: 12px;
            cursor: pointer; display: flex; align-items: center; gap: 3px;
            transition: 0.2s;
        }
        .react-btn:active { transform: scale(1.2); }
        .react-count { font-weight: bold; font-size: 11px; }

        .input-area { background: var(--card); padding: 10px 15px calc(15px + env(safe-area-inset-bottom)); display: flex; align-items: center; gap: 12px; }
        .input-wrap { flex: 1; background: #2c2c2e; border-radius: 20px; padding: 8px 15px; display: flex; align-items: center; }
        input[type="text"], input[type="password"] { flex: 1; background: transparent; border: none; color: white; outline: none; font-size: 16px; }

        #auth-screen {
            position: fixed; inset: 0; background: var(--bg); z-index: 1000;
            display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px;
        }
        .login-box { width: 100%; max-width: 320px; text-align: center; }
        .login-box h1 { font-size: 32px; margin-bottom: 10px; }
        .login-box input {
            width: 100%; padding: 16px; border-radius: 16px; border: none;
            background: var(--card); color: white; margin-bottom: 12px; font-size: 16px; text-align: center;
        }
        .login-box button {
            width: 100%; padding: 16px; border-radius: 16px; border: none;
            background: var(--vk-blue); color: white; font-weight: bold; font-size: 16px; cursor: pointer;
        }

        #progress { position: fixed; top: 0; left: 0; height: 3px; background: var(--vk-blue); width: 0%; z-index: 2000; transition: 0.3s; }
        .action-btn { color: var(--vk-blue); cursor: pointer; display: flex; align-items: center; }
    </style>
</head>
<body>

    <div id="progress"></div>

    <div id="auth-screen">
        <div class="login-box">
            <div style="font-size: 50px; margin-bottom: 20px;">‚ö°Ô∏è</div>
            <h1>–ö–û–õ–ò–ß</h1>
            <p style="color: var(--text-sec); margin-bottom: 30px;">–ß–∞—Ç —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤</p>
            <input type="text" id="user-name" placeholder="–õ–æ–≥–∏–Ω">
            <input type="password" id="user-pass" placeholder="–ü–∞—Ä–æ–ª—å" maxlength="8">
            <button onclick="handleLogin()">–í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</button>
            <p id="error-msg" style="color: #ff3b30; font-size: 13px; margin-top: 15px; display: none;"></p>
        </div>
    </div>

    <header>
        <div class="profile-info">
            <div class="avatar-main" id="my-avatar">?</div>
            <div>
                <b id="display-name">–ß–ê–¢ –ö–û–¢–û–ë–ê–ù–ö</b><br>
                <small id="online-counter" style="color: var(--text-sec);">–í —Å–µ—Ç–∏: ...</small>
            </div>
        </div>
        <div class="action-btn" onclick="logout()">
            <svg width="24" height="24" fill="currentColor" viewBox="0 0 24 24"><path d="M10.09 15.59L11.5 17l5-5-5-5-1.41 1.41L12.67 11H3v2h9.67l-2.58 2.59zM19 3H5c-1.11 0-2 .9-2 2v4h2V5h14v14H5v-4H3v4c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2z"/></svg>
        </div>
    </header>

    <div id="chat-flow"></div>

    <div class="input-area">
        <label class="action-btn">
            <svg width="28" height="28" fill="currentColor" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></svg>
            <input type="file" id="file-input" hidden accept="image/*,video/*" onchange="uploadFile(this)">
        </label>
        
        <div class="input-wrap">
            <input type="text" id="msg-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ...">
        </div>

        <div class="action-btn" onclick="sendMsg()">
            <svg width="28" height="28" fill="currentColor" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
        </div>
    </div>

    <script>
        // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
        const TG_TOKEN = "8548215166:AAHhHo_ODrDZl-6Lg5Zi-BpBIpeMzXdOEFE";
        const TG_CHAT_ID = "-1003486195563";
        
        const firebaseConfig = {
            apiKey: "AIzaSyA3J7KnUgxUHZigwRKmndm7xyxJeeLCrxg",
            databaseURL: "https://webapp-b7149-default-rtdb.europe-west1.firebasedatabase.app",
            storageBucket: "webapp-b7149.appspot.com",
            projectId: "webapp-b7149",
        };

        firebase.initializeApp(firebaseConfig);
        const rdb = firebase.database();
        const chatDb = rdb.ref('max_global_chat');
        const usersDb = rdb.ref('registered_users');
        const onlineDb = rdb.ref('online_users'); // –ü—É—Ç—å –¥–ª—è —Å—á–µ—Ç—á–∏–∫–∞ –æ–Ω–ª–∞–π–Ω–∞
        const storage = firebase.storage().ref('chat_media');

        let user = JSON.parse(localStorage.getItem('max_session'));

        if(user) {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('my-avatar').innerText = user.name[0].toUpperCase();
            initPresence(); // –ó–∞–ø—É—Å–∫ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ–Ω–ª–∞–π–Ω–∞
            initChat();
        }

        // --- –û–ù–õ–ê–ô–ù –°–ò–°–¢–ï–ú–ê ---
        function initPresence() {
            const myStatusRef = onlineDb.child(user.id);
            
            // –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –º–µ—Ö–∞–Ω–∏–∑–º Firebase –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –¥–∏—Å–∫–æ–Ω–Ω–µ–∫—Ç–∞
            rdb.ref('.info/connected').on('value', snap => {
                if (snap.val() === false) return;
                
                myStatusRef.onDisconnect().remove(); // –£–¥–∞–ª–∏—Ç—å –∏–∑ –æ–Ω–ª–∞–π–Ω–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –≤–∫–ª–∞–¥–∫–∏
                myStatusRef.set({ name: user.name, last_seen: Date.now() });
            });

            // –°–ª—É—à–∞—Ç–µ–ª—å –æ–±—â–µ–≥–æ —Å—á–µ—Ç—á–∏–∫–∞
            onlineDb.on('value', snap => {
                const count = snap.numChildren();
                document.getElementById('online-counter').innerText = `–í —Å–µ—Ç–∏: ${count}`;
            });
        }

        // --- –†–ï–ê–ö–¶–ò–ò ---
        function addReaction(msgKey, emoji) {
            const reactionRef = chatDb.child(`${msgKey}/reactions/${emoji}`);
            reactionRef.transaction(currentCount => (currentCount || 0) + 1);
        }

        // --- –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø –í TELEGRAM ---
        async function notifyTelegram(sender, text, type = 'text') {
            const content = type === 'text' ? text : `üì∑ –û—Ç–ø—Ä–∞–≤–∏–ª –º–µ–¥–∏–∞—Ñ–∞–π–ª`;
            const message = `üí¨ *${sender}* –≤ –ö–û–õ–ò–ß:\n${content}`;
            try {
                await fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendMessage`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ chat_id: TG_CHAT_ID, text: message, parse_mode: "Markdown" })
                });
            } catch (e) { console.error("TG Notify Error", e); }
        }

        // --- –õ–û–ì–ò–ö–ê –ß–ê–¢–ê ---
        async function handleLogin() {
            const name = document.getElementById('user-name').value.trim();
            const pass = document.getElementById('user-pass').value.trim();
            if(!name || !pass) return;

            usersDb.child(name).once('value', snapshot => {
                const userData = snapshot.val();
                if (userData) {
                    if (userData.password === pass) loginSuccess(userData);
                    else showError("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!");
                } else {
                    const newUser = { id: 'u' + Date.now(), name: name, password: pass };
                    usersDb.child(name).set(newUser);
                    loginSuccess(newUser);
                }
            });
        }

        function loginSuccess(uData) {
            localStorage.setItem('max_session', JSON.stringify(uData));
            location.reload();
        }

        function showError(txt) {
            const err = document.getElementById('error-msg');
            err.innerText = txt;
            err.style.display = 'block';
        }

        function logout() {
            if(user) onlineDb.child(user.id).remove(); // –£–¥–∞–ª—è–µ–º –∏–∑ –æ–Ω–ª–∞–π–Ω–∞ –ø—Ä–∏ —Ä—É—á–Ω–æ–º –≤—ã—Ö–æ–¥–µ
            localStorage.removeItem('max_session');
            location.reload();
        }

        function initChat() {
            chatDb.limitToLast(50).on('value', snap => {
                const flow = document.getElementById('chat-flow');
                flow.innerHTML = "";
                snap.forEach(child => {
                    const m = child.val();
                    const mKey = child.key;
                    const isMy = m.uid === user.id;
                    const div = document.createElement('div');
                    div.className = `msg ${isMy ? 'my' : 'other'}`;
                    
                    let html = `<span class="sender">${m.user}</span>`;
                    if(m.type === 'text') html += `<div>${m.text}</div>`;
                    else if(m.type === 'img') html += `<img src="${m.url}" onclick="window.open('${m.url}')">`;
                    else if(m.type === 'vid') html += `<video src="${m.url}" controls></video>`;
                    
                    // –ë–ª–æ–∫ —Ä–µ–∞–∫—Ü–∏–π
                    const heartCount = (m.reactions && m.reactions['‚ù§Ô∏è']) || 0;
                    const likeCount = (m.reactions && m.reactions['üëç']) || 0;

                    html += `
                        <div class="reactions-wrap">
                            <div class="react-btn" onclick="addReaction('${mKey}', '‚ù§Ô∏è')">
                                ‚ù§Ô∏è <span class="react-count">${heartCount || ''}</span>
                            </div>
                            <div class="react-btn" onclick="addReaction('${mKey}', 'üëç')">
                                üëç <span class="react-count">${likeCount || ''}</span>
                            </div>
                        </div>
                    `;
                    
                    div.innerHTML = html;
                    flow.appendChild(div);
                });
                flow.scrollTop = flow.scrollHeight;
            });
        }

        function sendMsg() {
            const inp = document.getElementById('msg-input');
            const val = inp.value.trim();
            if(!val) return;

            const msgData = { uid: user.id, user: user.name, text: val, type: 'text', time: Date.now() };
            chatDb.push(msgData);
            notifyTelegram(user.name, val, 'text');
            inp.value = "";
        }

        async function uploadFile(el) {
            const file = el.files[0];
            if(!file) return;
            const progress = document.getElementById('progress');
            progress.style.width = '20%';
            
            const ref = storage.child(Date.now() + '_' + file.name);
            const task = ref.put(file);
            
            task.on('state_changed', 
                s => progress.style.width = (s.bytesTransferred / s.totalBytes * 100) + '%',
                e => alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'),
                () => {
                    task.snapshot.ref.getDownloadURL().then(url => {
                        const type = file.type.includes('image') ? 'img' : 'vid';
                        chatDb.push({ uid: user.id, user: user.name, url: url, type: type, time: Date.now() });
                        notifyTelegram(user.name, "", type);
                        progress.style.width = '0%';
                    });
                }
            );
        }

        document.getElementById('msg-input').onkeypress = e => { if(e.key === 'Enter') sendMsg(); };
    </script>
</body>
</html>
