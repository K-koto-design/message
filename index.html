<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>–ö–û–õ–ò–ß</title>
    
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-storage-compat.js"></script>

    <style>
        :root {
            --vk-blue: #0077ff;
            --bg: #000000;
            --card: #1c1c1e;
            --text: #ffffff;
            --text-sec: #8e8e93;
            --my-msg: #0077ff;
            --other-msg: #262629;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); height: 100vh; display: flex; flex-direction: column; overflow: hidden; position: fixed; width: 100%; }

        header {
            padding: calc(env(safe-area-inset-top) + 25px) 16px 12px;
            background: rgba(20, 20, 22, 0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            display: flex; align-items: center; justify-content: space-between; border-bottom: 0.5px solid #2c2c2e; z-index: 100;
        }
        
        .avatar-main { width: 40px; height: 40px; border-radius: 12px; background: var(--vk-blue); display: flex; align-items: center; justify-content: center; font-weight: 700; }
        .header-center { flex: 1; margin-left: 12px; }
        .header-center b { display: block; font-size: 17px; letter-spacing: -0.4px; }
        .online-text { color: var(--vk-blue); font-size: 12px; font-weight: 500; }
        .typing-text { color: var(--text-sec); font-size: 11px; font-style: italic; min-height: 13px; }

        #chat-flow { flex: 1; overflow-y: auto; padding: 15px 12px; display: flex; flex-direction: column; gap: 10px; background: var(--bg); scroll-behavior: smooth; }
        
        .msg-wrap { display: flex; flex-direction: column; max-width: 85%; position: relative; }
        .msg-wrap.my { align-self: flex-end; }
        .msg-wrap.other { align-self: flex-start; }

        .sender { font-size: 11px; font-weight: 600; margin: 0 0 3px 4px; color: var(--text-sec); }

        .reply-box { 
            background: rgba(255,255,255,0.1); border-left: 3px solid #fff; 
            padding: 4px 8px; border-radius: 4px; margin-bottom: 5px; font-size: 13px; 
            color: rgba(255,255,255,0.8); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
        }

        .msg { padding: 10px 15px; border-radius: 20px; font-size: 16px; line-height: 1.4; word-wrap: break-word; }
        .my .msg { background: var(--my-msg); border-bottom-right-radius: 4px; }
        .other .msg { background: var(--other-msg); border-bottom-left-radius: 4px; }
        .msg img { max-width: 100%; border-radius: 12px; display: block; }

        #reply-preview { 
            display: none; background: #1c1c1e; padding: 8px 16px; 
            border-top: 0.5px solid #333; align-items: center; justify-content: space-between;
        }

        .input-area { background: #141416; padding: 10px 12px calc(10px + env(safe-area-inset-bottom)); display: flex; align-items: center; gap: 12px; border-top: 0.5px solid #2c2c2e; }
        .input-wrap { flex: 1; background: #262629; border-radius: 22px; padding: 10px 16px; }
        #msg-input { width: 100%; background: transparent; border: none; color: white; font-size: 16px; outline: none; }

        .react-menu {
            display: none; position: absolute; top: -50px; background: #2c2c2e;
            border-radius: 20px; padding: 6px 12px; gap: 12px; border: 0.5px solid #444; z-index: 1000; align-items: center;
        }
        .react-item { cursor: pointer; font-size: 18px; }
        .menu-action { font-size: 12px; font-weight: 600; color: #fff; cursor: pointer; padding: 0 4px; }
        .del-btn { color: #ff453a; border-left: 1px solid #444; padding-left: 8px; }

        .reaction-row { display: flex; gap: 4px; margin-top: -6px; z-index: 10; }
        .my .reaction-row { justify-content: flex-end; }
        .bubble { background: #262629; border: 1px solid #000; border-radius: 10px; padding: 2px 6px; font-size: 11px; cursor: pointer; }
        .bubble.active { border-color: var(--vk-blue); background: #3a3a3c; }

        #auth-screen { position: fixed; inset: 0; background: var(--bg); z-index: 10000; display: flex; align-items: center; justify-content: center; }
        .login-box { width: 80%; max-width: 300px; text-align: center; }
        .login-box input { width: 100%; padding: 16px; border-radius: 16px; border: none; background: var(--card); color: white; margin-bottom: 12px; text-align: center; }
        .login-box button { width: 100%; padding: 16px; border-radius: 16px; border: none; background: var(--vk-blue); color: white; font-weight: 700; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="login-box">
            <h1 style="font-size: 36px; margin-bottom: 30px;">–ö–û–õ–ò–ß</h1>
            <input type="text" id="user-name" placeholder="–ò–º—è">
            <input type="password" id="user-pass" placeholder="–ü–∞—Ä–æ–ª—å">
            <button onclick="handleLogin()">–í–æ–π—Ç–∏</button>
        </div>
    </div>

    <header>
        <div style="display:flex; align-items:center;">
            <div class="avatar-main" id="my-avatar">?</div>
            <div class="header-center">
                <b>–ö–û–¢–û–ë–ê–ù–ö</b>
                <div class="status-row">
                    <span class="online-text" id="online-list">...</span>
                    <span class="typing-text" id="typing-indicator"></span>
                </div>
            </div>
        </div>
        <div onclick="logout()" style="color:var(--text-sec); font-size: 14px;">–í—ã–π—Ç–∏</div>
    </header>

    <div id="chat-flow"></div>

    <div id="reply-preview">
        <div style="border-left: 2px solid var(--vk-blue); padding-left: 8px;">
            <div style="font-size: 11px; color: var(--vk-blue);" id="reply-name">–û—Ç–≤–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é</div>
            <div style="font-size: 13px; color: var(--text-sec); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 250px;" id="reply-text">–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è</div>
        </div>
        <div onclick="cancelReply()" style="color: var(--text-sec); font-size: 18px; padding: 5px;">‚úï</div>
    </div>

    <div class="input-area">
        <div onclick="promptImageUrl()" style="color: var(--vk-blue); cursor: pointer;">
            <svg width="28" height="28" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path d="M12 5v14M5 12h14" stroke-linecap="round"/></svg>
        </div>
        <div class="input-wrap">
            <input type="text" id="msg-input" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ" autocomplete="off" oninput="handleTyping()">
        </div>
        <div onclick="sendMsg()" style="color: var(--vk-blue); cursor: pointer;">
            <svg width="28" height="28" fill="currentColor" viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
        </div>
    </div>

    <script>
        const TG_TOKEN = "8548215166:AAHhHo_ODrDZl-6Lg5Zi-BpBIpeMzXdOEFE";
        const TG_CHAT_ID = "-1003486195563";

        const firebaseConfig = {
            apiKey: "AIzaSyARNjukxBwGfbODNpYRDowRg5ftB9qtZSU",
            authDomain: "message-65b09.firebaseapp.com",
            projectId: "message-65b09",
            storageBucket: "message-65b09.firebasestorage.app",
            messagingSenderId: "251547828052",
            appId: "1:251547828052:web:cee4f2b765d50e8572d2c1",
            databaseURL: "https://message-65b09-default-rtdb.firebaseio.com"
        };

        firebase.initializeApp(firebaseConfig);
        const rdb = firebase.database();
        const chatDb = rdb.ref('messages');
        const usersDb = rdb.ref('users');
        const onlineDb = rdb.ref('online');
        const typingDb = rdb.ref('typing');

        let user = JSON.parse(localStorage.getItem('max_session'));
        let replyData = null;
        let typingTimeout;

        if(window.visualViewport) {
            window.visualViewport.addEventListener('resize', () => {
                document.body.style.height = window.visualViewport.height + 'px';
                const flow = document.getElementById('chat-flow');
                flow.scrollTop = flow.scrollHeight;
            });
        }

        if(user) {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('my-avatar').innerText = user.name[0].toUpperCase();
            initPresence();
            initChat();
            initTypingListener();
        }

        async function handleLogin() {
            const n = document.getElementById('user-name').value.trim();
            const p = document.getElementById('user-pass').value.trim();
            if(!n || !p) return;
            const loginKey = n.toLowerCase();
            const snap = await usersDb.child(loginKey).once('value');
            const data = snap.val();
            if(data) {
                if(data.password === p) { localStorage.setItem('max_session', JSON.stringify(data)); location.reload(); }
                else { alert("–ü–∞—Ä–æ–ª—å –Ω–µ —Ç–æ—Ç"); }
            } else {
                const newUser = { id: 'u' + Date.now(), name: n, password: p };
                await usersDb.child(loginKey).set(newUser);
                localStorage.setItem('max_session', JSON.stringify(newUser));
                location.reload();
            }
        }

        function initPresence() {
            const myRef = onlineDb.child(user.id);
            rdb.ref('.info/connected').on('value', s => { if(s.val()) { myRef.onDisconnect().remove(); myRef.set(user.name); } });
            onlineDb.on('value', s => {
                const names = []; s.forEach(c => names.push(c.val()));
                document.getElementById('online-list').innerText = names.length > 0 ? "–í —Å–µ—Ç–∏: " + names.join(", ") : "–ù–∏–∫–æ–≥–æ –Ω–µ—Ç";
            });
        }

        function handleTyping() {
            typingDb.child(user.id).set(user.name);
            clearTimeout(typingTimeout);
            typingTimeout = setTimeout(() => typingDb.child(user.id).remove(), 2000);
        }

        function initTypingListener() {
            typingDb.on('value', s => {
                const typers = []; s.forEach(c => { if(c.key !== user.id) typers.push(c.val()); });
                document.getElementById('typing-indicator').innerText = typers.length ? typers.join(", ") + " –ø–µ—á–∞—Ç–∞–µ—Ç..." : "";
            });
        }

        function logout() { onlineDb.child(user.id).remove(); localStorage.clear(); location.reload(); }

        function showMenu(k) {
            document.querySelectorAll('.react-menu').forEach(m => m.style.display = 'none');
            const menu = document.getElementById('menu-' + k);
            menu.style.display = 'flex';
        }

        function setReply(k, name, text) {
            replyData = { key: k, name: name, text: text };
            document.getElementById('reply-name').innerText = name;
            document.getElementById('reply-text').innerText = text;
            document.getElementById('reply-preview').style.display = 'flex';
            document.getElementById('msg-input').focus();
            document.querySelectorAll('.react-menu').forEach(m => m.style.display = 'none');
        }

        function cancelReply() {
            replyData = null;
            document.getElementById('reply-preview').style.display = 'none';
        }

        function addReact(k, emoji) {
            const ref = chatDb.child(k + '/reactions');
            ref.once('value', s => {
                let r = s.val() || {};
                for(let e in r) { if(r[e][user.id]) delete r[e][user.id]; if(!Object.keys(r[e]).length) delete r[e]; }
                if(!s.child(emoji).child(user.id).exists()) { if(!r[emoji]) r[emoji] = {}; r[emoji][user.id] = true; }
                ref.set(r);
            });
            document.getElementById('menu-' + k).style.display = 'none';
        }

        function deleteMsg(k) { if(confirm("–£–¥–∞–ª–∏—Ç—å?")) chatDb.child(k).remove(); }

        function scrollToMsg(k) {
            const el = document.getElementById('msg-' + k);
            if(el) {
                el.scrollIntoView({ behavior: 'smooth', block: 'center' });
                el.style.background = '#333';
                setTimeout(() => el.style.background = '', 1000);
            }
        }

        function initChat() {
            chatDb.limitToLast(60).on('value', snap => {
                const flow = document.getElementById('chat-flow');
                flow.innerHTML = "";
                snap.forEach(child => {
                    const m = child.val(); const k = child.key; const isMy = m.uid === user.id;
                    const wrap = document.createElement('div');
                    wrap.className = `msg-wrap ${isMy ? 'my' : 'other'}`;
                    wrap.id = 'msg-' + k;
                    
                    let html = `
                        ${!isMy ? `<span class="sender">${m.user}</span>` : ''}
                        <div class="react-menu" id="menu-${k}">
                            <span class="react-item" onclick="addReact('${k}','‚ù§Ô∏è')">‚ù§Ô∏è</span>
                            <span class="react-item" onclick="addReact('${k}','üëç')">üëç</span>
                            <span class="menu-action" onclick="setReply('${k}','${m.user}','${m.text||'–§–æ—Ç–æ'}')">–û—Ç–≤–µ—Ç–∏—Ç—å</span>
                            ${isMy ? `<span class="menu-action del-btn" onclick="deleteMsg('${k}')">–£–¥–∞–ª–∏—Ç—å</span>` : ''}
                        </div>
                        <div class="msg" onclick="showMenu('${k}')">
                            ${m.replyTo ? `<div class="reply-box" onclick="event.stopPropagation(); scrollToMsg('${m.replyTo.key}')"><b>${m.replyTo.name}</b><br>${m.replyTo.text}</div>` : ''}
                            ${m.type === 'text' ? `<div>${m.text}</div>` : `<img src="${m.url}">`}
                        </div>
                    `;

                    if(m.reactions) {
                        html += `<div class="reaction-row">`;
                        for(let e in m.reactions) {
                            const count = Object.keys(m.reactions[e]).length;
                            const act = m.reactions[e][user.id] ? 'active' : '';
                            html += `<div class="bubble ${act}" onclick="event.stopPropagation(); addReact('${k}','${e}')">${e} ${count}</div>`;
                        }
                        html += `</div>`;
                    }
                    wrap.innerHTML = html; flow.appendChild(wrap);
                });
                flow.scrollTop = flow.scrollHeight;
            });
        }

        async function notifyTelegram(sender, text, type = 'text') {
            const msg = type === 'text' ? text : "üì∑ –§–æ—Ç–æ";
            fetch(`https://api.telegram.org/bot${TG_TOKEN}/sendMessage`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ chat_id: TG_CHAT_ID, text: `üí¨ *${sender}*:\n${msg}`, parse_mode: "Markdown" })
            });
        }

        function sendMsg() {
            const i = document.getElementById('msg-input'); if(!i.value.trim()) return;
            const data = { uid: user.id, user: user.name, text: i.value, type: 'text', ts: Date.now() };
            if(replyData) data.replyTo = replyData;
            chatDb.push(data);
            notifyTelegram(user.name, i.value);
            i.value = ""; cancelReply();
        }

        function promptImageUrl() {
            const url = prompt("–í—Å—Ç–∞–≤—å—Ç–µ –ø—Ä—è–º—É—é —Å—Å—ã–ª–∫—É –Ω–∞ —Ñ–æ—Ç–æ:");
            if(url && url.trim().startsWith('http')) {
                const data = { 
                    uid: user.id, 
                    user: user.name, 
                    url: url.trim(), 
                    type: 'img', 
                    ts: Date.now() 
                };
                if(replyData) data.replyTo = replyData;
                chatDb.push(data);
                notifyTelegram(user.name, url.trim(), "img");
                cancelReply();
            } else if (url) {
                alert("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–∞—è —Å—Å—ã–ª–∫–∞!");
            }
        }

        document.getElementById('msg-input').onkeypress = e => { if(e.key === 'Enter') sendMsg(); };
    </script>
</body>
</html>
